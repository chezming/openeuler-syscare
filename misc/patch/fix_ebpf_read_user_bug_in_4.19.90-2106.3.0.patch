From f90ebcd1d3c6ce073a65663e06e0bc2ecae43272 Mon Sep 17 00:00:00 2001
From: liqiang <liqiang64@huawei.com>
Date: Sun, 8 Oct 2023 11:38:34 +0800
Subject: [PATCH] fix ebpf read user bug in 4.19.90-2106.3.0

Signed-off-by: liqiang <liqiang64@huawei.com>
---
 kernel/trace/bpf_trace.c | 2 +-
 mm/maccess.c             | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/kernel/trace/bpf_trace.c b/kernel/trace/bpf_trace.c
index b8726b8..76a8b7d 100644
--- a/kernel/trace/bpf_trace.c
+++ b/kernel/trace/bpf_trace.c
@@ -173,7 +173,7 @@ BPF_CALL_3(bpf_probe_write_user, void *, unsafe_ptr, const void *, src,
 	if (!access_ok(unsafe_ptr, size))
 		return -EPERM;
 
-	return probe_kernel_write(unsafe_ptr, src, size);
+	return probe_user_write(unsafe_ptr, src, size);
 }
 
 static const struct bpf_func_proto bpf_probe_write_user_proto = {
diff --git a/mm/maccess.c b/mm/maccess.c
index 3538158..9059ff8 100644
--- a/mm/maccess.c
+++ b/mm/maccess.c
@@ -166,7 +166,7 @@ long strncpy_from_unsafe(char *dst, const void *unsafe_addr, long count)
 	if (unlikely(count <= 0))
 		return 0;
 
-	set_fs(KERNEL_DS);
+	set_fs(USER_DS);
 	pagefault_disable();
 
 	do {
-- 
2.27.0

